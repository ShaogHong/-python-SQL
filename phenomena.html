<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>全国天气统概</title>
    <style>
        #chart-container {
            position: relative;
            margin: auto;
            height: 85vh;
            width: 90vw;
            border: 2px solid rgb(194, 193, 193);
        }
    </style>
</head>
<body>
    <h1 style="text-align: center">全国天气统概</h1>
    <div id="chart-container">
        <canvas id="phenomenaChart"></canvas>
    </div>
<script>
    const apiUrl = `http://127.0.0.1:5000/get_query_phenomena`;

    fetch(apiUrl)
        .then(response => response.json())  // 使用 response.json() 获取 JSON 数据
        .then(data => {
            const phenomenaCounts = {};

            data.phenomena.forEach(entry => {
                const unescapedEntry = unescapeUnicode(entry);  // 反转义 Unicode 序列
                phenomenaCounts[unescapedEntry] = (phenomenaCounts[unescapedEntry] || 0) + 1;
            });

            const phenomenaLabels = Object.keys(phenomenaCounts);
            const phenomenaData = Object.values(phenomenaCounts);

            if (window.phenomenaChart) {
                window.phenomenaChart.destroy();
            }

            const phenomenaCtx = document.getElementById('phenomenaChart').getContext('2d');
            window.phenomenaChart = new Chart(phenomenaCtx, {
                type: 'bar',
                data: {
                    labels: phenomenaLabels,
                    datasets: [{
                        label: '现象',
                        data: phenomenaData,
                        backgroundColor: 'orange',
                        borderColor: 'orange',
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            stepSize: 1
                        }
                    },
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        })
        .catch(error => {
            console.log('Error:', error);
        });

    // 函数用于反转义 Unicode 序列
    function unescapeUnicode(str) {
        return str.replace(/\\u[\dA-F]{4}/gi, function (match) {
            return String.fromCharCode(parseInt(match.replace(/\\u/g, ''), 16));
        });
    }
</script>
</body>
</html>